name: CI - Quality & Tests

on:
  push:
    branches: [ "main", "dev", "ci-testing" ]
  pull_request:
    branches: [ "main", "dev", "ci-testing" ]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: LINTING & TYPE CHECKING (Fail Fast)
  # Checks if code is clean before running heavy tests
  # ------------------------------------------------------------------
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install Dependencies (Root & Recursive)
        # Assuming you might run npm install in root to bootstrap, 
        # or install individually. Here we install both.
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci

      - name: Lint Backend
        run: cd backend && npm run lint --if-present

      - name: Lint Frontend
        run: cd frontend && npm run lint --if-present

  # ------------------------------------------------------------------
  # JOB 2: BACKEND UNIT & INTEGRATION TESTS
  # Spins up a ephemeral Postgres Container
  # ------------------------------------------------------------------
  backend-tests:
    needs: code-quality
    runs-on: ubuntu-latest
    
    # Service Containers: This creates a real Postgres DB accessible via localhost:5432
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: roadmap_test_db
        ports:
          - 5432:5432
        # Simple health check to ensure DB is ready before steps start
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'backend/package-lock.json'

      - name: Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: Create Database & Run Tests
        # Important: Ensure your ORM syncs the schema before tests run
        working-directory: ./backend
        env:
          # Trigger the Test Configuration in your Factory
          NODE_ENV: test
          DB_TEST_TYPE: postgres
          ENV_DEV: dev
          ENV_TEST: test
          ENV_PROD: prod
          # Map your specific App variables to the Service Container
          DB_TEST_HOST: localhost
          DB_TEST_PORT: 5432
          DB_TEST_USER: test_user
          DB_TEST_PASSWORD: test_password
          DB_TEST_NAME: roadmap_test_db
          JWT_ACCESS_SECRET: super_secret_test_access
          JWT_REFRESH_SECRET: super_secret_test_refresh
        run: npm run test

# ------------------------------------------------------------------
  # JOB 3: FRONTEND UNIT & INTEGRATION TESTS
  # Runs frontend tests (no database needed)
  # ------------------------------------------------------------------
  frontend-tests:
    needs: code-quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run Tests
        # Important: Ensure your ORM syncs the schema before tests run
        working-directory: ./frontend
        env: 
          VITE_API_URL: "http://localhost:3000/api"
        run: npm run test

  # ------------------------------------------------------------------
  # JOB 4: FRONTEND E2E TESTS (Cypress)
  # Needs to run the Backend and Frontend together
  # ------------------------------------------------------------------
  cypress-e2e:
    needs: [backend-tests, frontend-tests]
    runs-on: ubuntu-latest
    
    # We need the DB for the backend to start
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: roadmap_test_db
        ports:
          - 5432:5432
        options: --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      # Install ALL dependencies (backend, frontend, and e2e)
      - name: Install Dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci
          cd ../e2e && npm ci

      # Start Backend in Background
      - name: Start Backend Server
        working-directory: ./backend
        env:
          NODE_ENV: test
          DB_TEST_TYPE: postgres
          DB_TEST_HOST: localhost
          DB_TEST_PORT: 5432
          DB_TEST_USER: test_user
          DB_TEST_PASSWORD: test_password
          DB_TEST_NAME: roadmap_test_db
          ENV_DEV: dev
          ENV_TEST: test
          ENV_PROD: prod
          JWT_ACCESS_SECRET: super_secret_test_access
          JWT_REFRESH_SECRET: super_secret_test_refresh
          PORT: 3000
        run: |
          echo "Starting backend server..."
          nohup npm run dev > ../backend.log 2>&1 &
          echo $! > ../backend.pid
          echo "Backend PID: $(cat ../backend.pid)"
          sleep 10
          echo "Checking if backend is running..."
          if ps -p $(cat ../backend.pid) > /dev/null; then
            echo "Backend process is running"
          else
            echo "Backend process died! Showing logs:"
            cat ../backend.log
            exit 1
          fi

      # Start Frontend in Background
      - name: Start Frontend Server
        working-directory: ./frontend
        env:
          VITE_API_URL: http://localhost:3000/api
        run: |
          echo "Starting frontend server..."
          nohup npm run dev -- --host > ../frontend.log 2>&1 &
          echo $! > ../frontend.pid
          echo "Frontend PID: $(cat ../frontend.pid)"
          sleep 5

      # Wait for servers to be ready
      - name: Wait for Servers
        run: |
          echo "Waiting for servers to be ready..."
          npx wait-on tcp:3000 tcp:5173 -t 180000 --interval 2000 --verbose || {
            echo "Servers failed to start. Checking logs..."
            echo "=== Backend Log ==="
            cat backend.log || echo "No backend log"
            echo ""
            echo "=== Frontend Log ==="
            cat frontend.log || echo "No frontend log"
            echo ""
            echo "=== Backend Process ==="
            ps aux | grep "npm run dev" || echo "No backend process"
            exit 1
          }
          echo "Both servers are ready!"
          echo "Waiting additional 5 seconds for full initialization..."
          sleep 5

      # Run Cypress E2E Tests
      - name: Run Cypress E2E Tests
        working-directory: ./e2e
        env:
          CYPRESS_BASE_URL: http://localhost:5173
          CYPRESS_API_URL: http://localhost:3000/api
        run: npm test

      # Upload Cypress screenshots on failure
      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: e2e/cypress/screenshots
          if-no-files-found: ignore

      # Upload Cypress videos
      - name: Upload Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: e2e/cypress/videos
          if-no-files-found: ignore